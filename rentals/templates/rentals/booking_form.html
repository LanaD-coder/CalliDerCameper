{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<section id="booking-section" class="form-section">
  <h2>{% trans "Book Calli the Camper" %}</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="form-message">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form id="booking-form" method="POST" action="{% url 'create_booking_ajax' campervan.pk %}" novalidate>
    {% csrf_token %}

    <fieldset>
      <legend>{% trans "Buchungszeitraum" %}</legend>
      <p class="text-muted small mt-1">
        <i class="fa-solid fa-circle-exclamation me-1"></i>
        {% trans "Sie müssen ein registrierter, eingeloggter Benutzer sein, um die Buchung abzuschließen." %}
      </p>

      <label for="{{ form.start_date.id_for_label }}">{% trans "Startdatum" %}</label>
      {{ form.start_date }}
      <div class="field-error">{{ form.start_date.errors }}</div>

      <label for="{{ form.end_date.id_for_label }}">{% trans "Enddatum" %}</label>
      {{ form.end_date }}
      <div class="field-error">{{ form.end_date.errors }}</div>

      <div class="calendar-legend" style="margin-top: 1rem;">
        <strong>{% trans "Bitte beachten:" %}</strong>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
          <div style="width: 16px; height: 16px; background-color: #cccccc; border: 1px solid #999999;"></div>
          <span>{% trans "Ausgegraute Tage sind nicht buchbar." %}</span>
        </div>
      </div>

      <div class="alert alert-info" style="margin-top: 1rem;">
        <strong>{% trans "Grundpreis für den ausgewählten Zeitraum:" %}</strong>
        <span id="base-rental-cost">--</span> €
      </div>
    </fieldset>

    <fieldset>
      <legend>{% trans "Details des Hauptfahrers" %}</legend>
      <p class="text-muted small mt-1">
        <i class="fa-solid fa-circle-exclamation me-1"></i>
        {% trans "Die fahrende Person muss mindestens 21 Jahre alt sein." %}
      </p>

      {{ form.primary_driver_name.label_tag }}
      {{ form.primary_driver_name }}
      <div class="field-error">{{ form.primary_driver_name.errors }}</div>

      {{ form.primary_driver_street_name.label_tag }}
      {{ form.primary_driver_street_name }}
      <div class="field-error">{{ form.primary_driver_street_name.errors }}</div>

      {{ form.primary_driver_street_number.label_tag }}
      {{ form.primary_driver_street_number }}
      <div class="field-error">{{ form.primary_driver_street_number.errors }}</div>

      {{ form.primary_driver_postal_code.label_tag }}
      {{ form.primary_driver_postal_code }}
      <div class="field-error">{{ form.primary_driver_postal_code.errors }}</div>

      {{ form.primary_driver_town.label_tag }}
      {{ form.primary_driver_town }}
      <div class="field-error">{{ form.primary_driver_town.errors }}</div>

      {{ form.primary_driver_country.label_tag }}
      {{ form.primary_driver_country }}
      <div class="field-error">{{ form.primary_driver_country.errors }}</div>
    </fieldset>

    <fieldset>
      <legend>{% trans "Zusatzfahrer (optional)" %}</legend>

      <label>{% trans "Zusatzfahrer hinzufügen?" %}</label><br>
      <input type="radio" name="add_additional_driver" id="add_driver_yes" value="yes">
      <label for="add_driver_yes">{% trans "Ja" %}</label>
      <input type="radio" name="add_additional_driver" id="add_driver_no" value="no" checked>
      <label for="add_driver_no">{% trans "Nein" %}</label>

      <div id="additional-driver-fields" style="display:none; margin-top:1em;">
        {{ form.additional_driver_name.label_tag }}
        {{ form.additional_driver_name }}
        <div class="field-error">{{ form.additional_driver_name.errors }}</div>

        {{ form.additional_driver_email.label_tag }}
        {{ form.additional_driver_email }}
        <div class="field-error">{{ form.additional_driver_email.errors }}</div>

        {{ form.additional_driver_contact_number.label_tag }}
        {{ form.additional_driver_contact_number }}
        <div class="field-error">{{ form.additional_driver_contact_number.errors }}</div>

        <fieldset class="address-fieldset" style="margin-top:1em;">
          <legend>{% trans "Address" %}</legend>

          {{ form.additional_driver_street.label_tag }}
          {{ form.additional_driver_street }}
          <div class="field-error">{{ form.additional_driver_street.errors }}</div>

          {{ form.additional_driver_postal_code.label_tag }}
          {{ form.additional_driver_postal_code }}
          <div class="field-error">{{ form.additional_driver_postal_code.errors }}</div>

          {{ form.additional_driver_town.label_tag }}
          {{ form.additional_driver_town }}
          <div class="field-error">{{ form.additional_driver_town.errors }}</div>

          {{ form.additional_driver_country.label_tag }}
          {{ form.additional_driver_country }}
          <div class="field-error">{{ form.additional_driver_country.errors }}</div>
        </fieldset>
      </div>
    </fieldset>

    <fieldset>
      <legend>{% trans "Kaution" %}</legend>
      <div class="form-check">
        <input type="checkbox" class="form-check-input" checked disabled>
        <label class="form-check-label">{% trans "Kaution (1000 €) – automatisch angewendet" %}</label>
      </div>
      {{ form.deposit_hidden }}
    </fieldset>

    <fieldset>
      <legend>{% trans "Zusatzleistungen" %}</legend>
      {{ form.additional_services }}
      <div class="field-error">{{ form.additional_services.errors }}</div>
    </fieldset>

    <div class="mt-4">
      <input type="checkbox" id="accept-datenschutz" required>
      <label for="accept-datenschutz">
        Ich akzeptiere die
        <a href="{% url 'datenschutz' %}?return_url={% url 'booking_page' campervan.pk %}">
          Datenschutzerklärung
        </a>
      </label>
    </div>

    <fieldset>
      <legend><strong>{% trans "Zusammenfassung" %}</strong></legend>
      <p><strong>{% trans "Grundpreis:" %}</strong> <span id="summary-base-price">--</span> €</p>
      <p><strong>{% trans "Zusatzleistungen:" %}</strong> <span id="summary-services-price">--</span> €</p>
      <p><strong>{% trans "Kaution:" %}</strong> <span id="summary-deposit-price">1000</span> €</p>

      <!-- NEW VAT DISPLAY -->
      <p><strong>{% trans "MwSt (19%):" %}</strong> <span id="summary-vat">--</span> €</p>

      <p><strong>{% trans "Gesamtpreis inkl. MwSt:" %}</strong> <span id="summary-grand-total">--</span> €</p>
    </fieldset>

    <input type="hidden" name="status" value="active">
    <!-- Stripe Card Element goes here -->
    <div id="card-element" style="display: none;"></div>

    <!-- Stripe will insert card UI into this -->
    <div id="card-errors" role="alert"></div>

    <button type="submit" id="book-now-btn">
      {% trans "Confirm & Pay" %}
    </button>
    <p class="text-muted small mt-1">
        <i class="fa-solid fa-circle-exclamation me-1"></i>
         {% trans "Bitte überprüfen Sie alle Angaben sorgfältig, bevor Sie auf „Bestätigen & Bezahlen“ klicken. Die Zahlung darf nicht unterbrochen werden. Falls ein Problem auftritt, kontaktieren Sie bitte die Administration unter buchung@callidercamper.de." %}
      </p>
  </form>
</section>

<div id="form-errors" style="display:none; color:red; margin-top:10px;"></div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<!-- Booking.js -->
<script src="{% static 'js/booking.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const datePrices = {{ date_prices|default:"{}"|safe }};
    const servicePrices = {{ additional_service_prices_json|default:"{}"|safe }};
    const blockedDates = {{ blocked_dates_json|default:"[]"|safe }};
    const ajaxUrl = "{% url 'create_booking_ajax' campervan.pk %}";

    // Initialize booking form and pass blockedDates
    initBookingForm({
        datePrices: datePrices,
        additionalServicePrices: servicePrices,
        blockedDates: blockedDates,
        ajaxUrl: ajaxUrl
    });
});
</script>

<!-- Optional toast messages -->
<script>
{% if messages %}
    {% for message in messages %}
        toast.error("{{ message|escapejs }}");
    {% endfor %}
{% endif %}
</script>

<!-- Modal for login/register prompt -->
<div id="loginPromptModal" style="display:none;">
  <div style="background:white; padding:20px; border-radius:8px; max-width:400px; text-align:center;">
    <h2>{% trans "You need to be a registered user to book Calli." %}</h2>
    {% url 'account_login' as login_url %}
    {% url 'account_signup' as signup_url %}
    <p>
      {% blocktrans %}
      Please <a href="{{ login_url }}">log in</a> or <a href="{{ signup_url }}">sign up</a> to make a booking.
      {% endblocktrans %}
    </p>
    <button onclick="document.getElementById('loginPromptModal').style.display='none'"
            style="border:0; border-radius:0.8rem; background-color:#0dc1bf; color:white;">
      Close
    </button>
  </div>
</div>


{% endblock %}
